# TICKET-007 COMPLETION REPORT

- 티켓 ID: TICKET-007
- 티켓명: LLD-OPM 작성
- 완료일: 2026-02-17
- 담당: LLD agent (OPM)
- 입력 문서:
  - `docs/hld/HLD-v0.1.0.md` (4.3, 5, 6)
  - `docs/lld/LLD-KIA-v0.1.0.md`
  - `docs/lld/LLD-PRP-v0.1.0.md`
- 산출 문서:
  - `docs/lld/LLD-OPM-v0.1.0.md`

## 1) 수행 결과

- OPM 모듈 범위/책임을 HLD 4.3 기준으로 상세화 완료
- 주문 수명주기 상태머신 및 포지션 상태전이(FLAT~CLOSED) 정의 완료
- 포지션 모델(수량/평단/중간손익/실현손익) 및 계산식 정의 완료
- 매도 단가 `현재가-2틱` 규칙과 KOSPI 호가단위 가정 명세 완료
- OPM↔KIA, OPM↔PRP 인터페이스 계약 및 DTO 규칙 정리 완료
- 주문 멱등성(`clientOrderId`)과 체결 멱등성(`executionId`) 처리 설계 완료
- 타임아웃/불확실 응답 시 RECONCILING 기반 정합 절차 설계 완료
- 시퀀스 다이어그램(매수/매도/정합) 및 핵심 의사코드 작성 완료
- 오류 분류/재시도 정책(재주문 금지 경계 포함) 정의 완료
- HLD/SRS 추적성 매트릭스 작성 완료

## 2) 핵심 설계 결정

### 결정 1: 주문 타임아웃 시 즉시 재주문 금지, 정합 우선
- 방식: `submitOrder` 타임아웃은 `RECONCILING` 전환 후 `fetchExecution` 기반 확인
- 근거: HLD 6.2 멱등/중복방지 원칙
- 영향: 네트워크 불확실성 상황에서 중복 주문 리스크 최소화

### 결정 2: 체결 이벤트는 executionId 단위 멱등 적용
- 방식: `ExecutionLedger`로 `executionId` 중복 수신 차단
- 근거: HLD 6.1 데이터 장애(체결 누락/중복) 대응
- 영향: 부분체결 반복 조회에서도 포지션 수량/평단 왜곡 방지

### 결정 3: 매도 단가는 현재가-2틱 + 하향 정렬
- 방식: `sellPrice = alignDown(currentPrice - 2*tick)`
- 근거: HLD 4.3, SRS FR-011
- 영향: 시장 호가단위 위반 없는 일관된 지정가 생성

## 3) 체크리스트

- [x] HLD 4.3 주문/포지션 책임 반영
- [x] HLD 5 모듈 인터페이스 계약 반영
- [x] HLD 6 장애/복구/정합/멱등성 반영
- [x] KIA 연계(주문/체결/잔고 조회) 반영
- [x] PRP 연계(주문·체결·스냅샷 저장) 반영
- [x] SRS FR-011(현재가-2틱) 반영
- [x] SRS NFR-003/NFR-004/NFR-005 반영
- [x] 한국어 문서화

## 4) 리스크 및 후속 권고

- 리스크: KOSPI 호가단위 예외(ETF/특례) 미반영 시 가격 검증 불일치 가능
- 권고: 운영 시 KIA `MarketQuote.tickSize`를 1순위로 사용하고, 미제공 시 테이블 fallback 유지
- 권고: 정합 루프의 타임윈도우/최대 시도 횟수는 실거래 로그 기반 튜닝 필요
- 권고: PRP 저장 실패 시 임시 큐 내구성(프로세스 종료 대비) 구현 상세를 ILD에서 확정

## 5) 결론

TICKET-007 요구사항(LLD-OPM 문서 신규 작성 및 주문 상태머신/포지션·PnL/현재가-2틱/KIA·PRP 인터페이스/멱등·정합/시퀀스·의사코드/오류·재시도/추적성 포함)을 충족하여 완료 처리한다.
